#!/bin/bash
# SMB exploitation - targets Dionaea

DIONAEA="172.16.0.30"
LOGDIR="/home/kali/Desktop/fyp/attack_scripts/logs/exploitation"
USERS="/usr/share/seclists/Usernames/top-usernames-shortlist.txt"
PASS="/usr/share/seclists/Passwords/Common-Credentials/xato-net-10-million-passwords-1000.txt"

mkdir -p "$LOGDIR"

echo "SMB exploitation on $DIONAEA"

if nc -zw2 "$DIONAEA" 445 2>/dev/null; then
    nmap -p 445 --script smb-os-discovery,smb-enum-shares "$DIONAEA" -oN "$LOGDIR/smb_nmap_${DIONAEA}.txt"
    
    RCFILE="/tmp/msf_smb_${DIONAEA}.rc"
    cat > "$RCFILE" << EOF
use auxiliary/scanner/smb/smb_version
set RHOSTS $DIONAEA
run
use auxiliary/scanner/smb/smb_enumshares
set RHOSTS $DIONAEA
run
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS $DIONAEA
run
exit
EOF
    timeout 120 msfconsole -q -r "$RCFILE" 2>/dev/null > "$LOGDIR/smb_msf_${DIONAEA}.txt"
    rm -f "$RCFILE"
else
    echo "SMB not open"
fi

echo "Done"
